name: CI/CD â€” Deploy frontend to S3 & CloudFront (optional backend deploy)

on:
  push:
    branches: [ main ]

env:
  S3_BUCKET: nbntech-frontend
  CLOUDFRONT_DISTRIBUTION_ID: E1P3KA7L8DP9Z1
  AWS_REGION: us-east-1

jobs:
  frontend-deploy:
    name: Deploy frontend to S3 + invalidate CloudFront
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '16.20.2'

      - name: Install dependencies (if present)
        run: |
          npm ci --if-present --no-audit --no-fund

      - name: Build (if present)
        run: |
          npm run build --if-present

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync static site to S3
        env:
          S3_BUCKET: ${{ env.S3_BUCKET }}
        run: |
          echo "Syncing files to s3://$S3_BUCKET"
          aws s3 sync . s3://$S3_BUCKET \
            --exclude ".git/*" \
            --exclude "server/*" \
            --exclude "infra/*" \
            --exclude "node_modules/*" \
            --delete \
            --acl public-read \
            --cache-control "public, max-age=86400"

      - name: Create CloudFront invalidation
        run: |
          echo "Invalidating CloudFront distribution: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: Smoke test CDN and site
        run: |
          set -e
          # Try to get CloudFront domain
          DOMAIN=$(aws cloudfront get-distribution --id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --query "Distribution.DomainName" --output text 2>/dev/null || true)
          if [ -z "$DOMAIN" ]; then
            echo "Could not determine CloudFront domain; skipping CDN content checks.";
            exit 0
          fi
          echo "CloudFront domain: $DOMAIN"
          echo "Checking https://$DOMAIN/script.js"
          curl -sSf --max-time 10 "https://$DOMAIN/script.js" | grep -E "IntersectionObserver|hero-bg" && echo "CDN script looks updated" || echo "Warning: CDN script may not contain expected markers"

  backend-deploy:
    name: Deploy backend (optional via SSH)
    runs-on: ubuntu-latest
    needs: frontend-deploy
    if: ${{ secrets.SSH_HOST && secrets.SSH_PRIVATE_KEY }}
    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            BACKEND_DIR="${{ secrets.BACKEND_DIR || '/home/ec2-user/server/server' }}"
            cd "$BACKEND_DIR"
            git fetch --all --prune
            git checkout main || true
            git reset --hard origin/main
            if [ -f package-lock.json ]; then
              npm ci --no-audit --no-fund
            else
              npm install --no-audit --no-fund
            fi
            PM2_NAME="nbn-backend"
            if pm2 describe "$PM2_NAME" >/dev/null 2>&1; then
              pm2 restart "$PM2_NAME"
            else
              pm2 start npm --name "$PM2_NAME" -- start
            fi
            pm2 save
            # quick health check
            if curl -sSf --max-time 10 "${{ env.API_ENDPOINT || 'https://dhq9341hf4.execute-api.us-east-1.amazonaws.com' }}/api/health" >/dev/null; then
              echo "Backend health check OK"
            else
              echo "Warning: backend health check failed";
            fi
